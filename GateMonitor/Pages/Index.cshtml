@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<div class="container mt-4">

    <div class="text-center mb-4">
        <h1 class="display-4 mb-2">Recent RFID Scans</h1>
        <p class="text-muted">
            This page shows the latest RFID scan attempts performed at the machine.
        </p>
    </div>

    <div class="table-responsive" id="rfidTableContainer">
        @if (Model.RfidRecords != null && Model.RfidRecords.Count > 0)
        {
            <table id="rfidTable" class="table table-striped table-bordered table-hover">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Worker</th>
                    <th>RFID UID</th>
                    <th>Action</th>
                    <th>Success</th>
                    <th>Scanned At</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var record in Model.RfidRecords)
                {
                    <tr>
                        <td>@record.Id</td>
                        <td>@record.Worker?.FirstName @record.Worker?.LastName</td>
                        <td>@record.RfidUid</td>
                        <td>
                            @if (record.RfidScanAction is null)
                            {
                                <span class="badge bg-secondary">Unknown</span>
                            }
                            else if (record.Success == false)
                            {
                                <span class="badge bg-warning text-dark">Failed Attempt</span>
                            }
                            else
                            {
                                @switch (record.RfidScanAction.PrettyName)
                                {
                                    case "Turned On":
                                        <span class="badge bg-success">Machine Turned On</span>
                                        break;

                                    case "Turned Off":
                                        <span class="badge bg-danger">Machine Turned Off</span>
                                        break;

                                    default:
                                        <span class="badge bg-secondary">@record.RfidScanAction.PrettyName</span>
                                        break;
                                }
                            }
                        </td>


                        <td>
                            @if (record.Success)
                            {
                                <span class="badge bg-success">SUCCESS</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">FAILED</span>
                            }
                        </td>
                        <td class="local-time" data-ts="@record.CreatedAt">
                                @IndexModel.FormatTimestamp(record.CreatedAt.ToLocalTime())
                        </td>
                    </tr>
                }

                </tbody>
            </table>
        }
        else
        {
            <div class="alert alert-info text-center">
                No Rfid scans found.
            </div>
        }
        <div class="d-flex justify-content-center mt-3">
            <nav>
                <ul class="pagination">
                    <li class="page-item @(Model.PageNumber == 1 ? "disabled" : "")">
                        <a class="page-link" href="?pageNumber=@(Model.PageNumber - 1)">Previous</a>
                    </li>

                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        <li class="page-item @(Model.PageNumber == i ? "active" : "")">
                            <a class="page-link" href="?pageNumber=@i">@i</a>
                        </li>
                    }

                    <li class="page-item @(Model.PageNumber == Model.TotalPages ? "disabled" : "")">
                        <a class="page-link" href="?pageNumber=@(Model.PageNumber + 1)">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const elements = document.querySelectorAll(".local-time");

        elements.forEach(el => {
            const utc = el.getAttribute("data-utc");
            if (!utc) return;

            const date = new Date(utc);

            // Format in LOCAL time
            el.textContent = date.toLocaleString([], {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit"
            });
        });
    });
</script>
<script>
    function formatTimestamp(date) {
        const now = new Date();

        const isToday =
            date.getDate() === now.getDate() &&
            date.getMonth() === now.getMonth() &&
            date.getFullYear() === now.getFullYear();

        if (isToday) {
            // Today → precise HH:mm:ss (24h)
            return date.toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                hour12: false
            });
        }

        // Older → dd-MM-yyyy HH:mm (24h)
        const fullDate = date.toLocaleDateString("en-GB"); // gives DD/MM/YYYY
        const time = date.toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false
        });

        // Convert en-GB date (dd/mm/yyyy) into dd-mm-yyyy
        const parts = fullDate.split("/");
        return `${parts[0]}-${parts[1]}-${parts[2]} ${time}`;
    }

    function updateTimestamps() {
        document.querySelectorAll(".timestamp").forEach(td => {
            const iso = td.getAttribute("data-ts");
            if (!iso) return;

            td.textContent = formatTimestamp(new Date(iso));
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        updateTimestamps();
        setInterval(updateTimestamps, 10000);
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.9/signalr.min.js"></script>

<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/rfidHub")
        .withAutomaticReconnect()
        .build();

    connection.start()
        .then(() => console.log("Connected to RfidHub"))
        .catch(err => console.error(err.toString()));

    connection.on("NewRfidScan", record => {
        const tbody = document.querySelector("#rfidTable tbody");
        const tr = document.createElement("tr");

        // Determine action badge
        let actionBadge = "";
        if (!record.rfidScanAction) {
            actionBadge = `<span class="badge bg-secondary">Unknown</span>`;
        } else if (record.success === false) {
            actionBadge = `<span class="badge bg-warning text-dark">Failed Attempt</span>`;
        } else {
            switch(record.rfidScanAction) {
                case "Turned On":
                    actionBadge = `<span class="badge bg-success">Machine Turned On</span>`;
                    break;
                case "Turned Off":
                    actionBadge = `<span class="badge bg-danger">Machine Turned Off</span>`;
                    break;
                default:
                    actionBadge = `<span class="badge bg-secondary">${record.rfidScanAction}</span>`;
                    break;
            }
        }

        // Determine success badge
        const successBadge = record.success
            ? `<span class="badge bg-success">SUCCESS</span>`
            : `<span class="badge bg-danger">FAILED</span>`;

        // Build table row
        tr.innerHTML = `
            <td>${record.id}</td>
            <td>${record.worker?.firstName ?? ""} ${record.worker?.lastName ?? ""}</td>
            <td>${record.rfidUid}</td>
            <td>${actionBadge}</td>
            <td>${successBadge}</td>
            <td class="timestamp" data-ts="${record.createdAt}">${record.createdAt}</td>
        `;

        tbody.prepend(tr);
        updateTimestamps(); // refresh timestamps
    });
</script>




