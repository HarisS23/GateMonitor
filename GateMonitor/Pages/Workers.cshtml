@page
@model GateMonitor.Pages.WorkersModel
@{
    ViewData["Title"] = "Workers";
}
<div class="container mt-5">
    <h1 class="display-4 text-center mb-4">@ViewData["Title"]</h1>

    @if (Model.Workers != null && Model.Workers.Count > 0)
    {
        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover text-center">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>RFID UID</th>
                    <th>Has Access</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var worker in Model.Workers)
                {
                    <tr>
                        <td>@worker.Id</td>
                        <td>@worker.FirstName</td>
                        <td>@worker.LastName</td>
                        <td>@worker.RfidUid</td>
                        <td>
                            @if (worker.HasAccess)
                            {
                                <span class="badge bg-success">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">No</span>
                            }
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-gear me-1"></i>
                                </button>

                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <button class="dropdown-item d-flex align-items-center gap-2 
                               @(worker.HasAccess ? "text-warning bg-warning-subtle" : "text-success bg-success-subtle")"
                                                onclick="toggleAccess(@worker.Id, @worker.HasAccess.ToString().ToLower())">
                                            <i class="bi bi-shield-check"></i>
                                            @(worker.HasAccess ? "Revoke Access" : "Grant Access")
                                        </button>
                                    </li>
                                    <li>
                                        <button class="dropdown-item text-danger bg-danger-subtle d-flex align-items-center gap-2"
                                                onclick="deleteWorker(@worker.Id)">
                                            <i class="bi bi-trash"></i>
                                            Delete
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            No workers found.
        </div>
    }
</div>
<script>
    async function deleteWorker(workerId) {
        if (typeof confirmModal === "undefined") {
            console.error("Modal is not initialized.");
            return;
        }

        actionText.textContent = "delete"; 
        
        modalAction = async () => {
            const response = await fetch(`/api/workers/${workerId}`, { method: "DELETE" });
            if (!response.ok) {
                const text = await response.text();
                alert("Failed to delete worker: " + text);
            } else {
                location.reload();
            }
        };

        confirmModal.show(); 
    }

    async function toggleAccess(workerId, hasAccess) {
        if (typeof confirmModal === "undefined") {
            console.error("Modal is not initialized.");
            return;
        }

        const action = hasAccess ? "revoke" : "grant";
        actionText.textContent = action;

        modalAction = async () => {
            const newAccess = !hasAccess;
            const response = await fetch(`/api/workers/access/${workerId}/${newAccess}`, { method: "PATCH" });
            if (!response.ok) {
                const text = await response.text();
                alert("Failed to toggle access: " + text);
            } else {
                location.reload();
            }
        };

        confirmModal.show();
    }
</script>

